name: ğŸš€ CI/CD Pipeline - Dokploy Deployment

on:
  push:
    branches:
      - main
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Clonar repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ§± Construir imagen Docker
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/proyecto-devops:latest ./backend

      - name:  Subir imagen a Docker Hub
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/proyecto-devops:latest

      - name: ğŸŒ Desplegar en Dokploy
         env:
    DOKPLOY_API_KEY: ${{ secrets.DOKPLOY_API_KEY }}
  run: |
    echo "Iniciando despliegue en Dokploy a travÃ©s de ngrok..."
    curl -X POST https://quimiotÃ¡cticamente-semisartÃ­tica-melita.ngrok-free.dev/api/deploy \
    -H "Authorization: Bearer $DOKPLOY_API_KEY" \
    -H "Content-Type: application/json" \
    -d '{
          "service": "proyecto-devops",
          "image": "'"${{ secrets.DOCKERHUB_USERNAME }}"'/proyecto-devops:latest"
        }'
    echo "Despliegue iniciado correctamente."